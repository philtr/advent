F,C,V,E=[$<.map{_1.chomp.chars.map(&:to_i)},->(j){F.map{_1[j]}},->(i,j,r,c){[r[0..(j-1)].reverse,r[(j+1)..-1],c[0..(i-1)].reverse,c[(i+1)..-1]]},->(i,j){i==0||i==(F.size-1)||j==0||j==(F[1].size-1)}]
p [F.reduce([0,0]){|(n,i),r|next[n+r.size,i+1]if E.(i,-1);[r.reduce([n,0]){|(n,j),t|next [n+1,j+1]if E.(i,j);V.(i,j,r,C.(j)).any?{|d|d.all?{_1<t}}?[n+1,j+1]:[n,j+1]}[0],i+1]}[0],F.reduce([0,0]){|(m,i),r|[[m,r.reduce([m,0]){|(m,j),h|[[m,V.(i,j,r,C.(j)).map{_1.reduce(0){|v,t|t<h||(break v+1);v+1}}.reduce(&:*)].max,j+1]}[0]].max,i+1]}[0]]
